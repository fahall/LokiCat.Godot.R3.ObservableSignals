using System.Text;
using LokiCat.Godot.R3.ObservableSignals.ObservableGenerator.Features.SyntaxHelpers;
using Microsoft.CodeAnalysis;
using Microsoft.CodeAnalysis.Text;

namespace LokiCat.Godot.R3.ObservableSignals.ObservableGenerator.Features.Generators;

internal static class RxPropertyGenerator
{
  private const string PUBLIC_PREFIX_BOOL = "Is";
  private const string PRIVATE_PREFIX_BOOL = "_is";
  
  private const string PUBLIC_PREFIX = "Current";
  private const string PRIVATE_PREFIX = "_current";
  
  private const string CONNECTION_FLAG_SUFFIX = "Connected";
  
  internal static void Emit(
    GeneratorExecutionContext context,
    string className,
    string nameSpace,
    string delegateName,
    ParameterDefinition parameters,
    string? inverseName,
    SemanticModel model)
  {
    
    context.ReportDiagnostic(Diagnostic.Create(
                               new DiagnosticDescriptor(
                                 "DEBUGPROP",
                                 "Debug",
                                 "Generating RxProp for: {0}",
                                 "Debug",
                                 DiagnosticSeverity.Info,
                                 true),
                               Location.None,
                               delegateName));
    
    var signalBaseName = GodotSignalUtilities.GetSignalBaseName(delegateName);
    // Choose prefixes based on whether the property type is bool
    
    var isBoolType = parameters.AggregateType == "bool";
    var publicPrefix = isBoolType ? PUBLIC_PREFIX_BOOL : PUBLIC_PREFIX;
    var privatePrefix = isBoolType ? PRIVATE_PREFIX_BOOL : PRIVATE_PREFIX;
    
    var propertyName = signalBaseName.WithDedupedPrefix(publicPrefix);
    var fieldName = signalBaseName.WithDedupedPrefix(privatePrefix);
    
    var connectedFlag = $"{fieldName}{CONNECTION_FLAG_SUFFIX}";
    
    var emissionBody = new StringBuilder();
    emissionBody.AppendSignalWiring(signalBaseName, parameters.Count);
    emissionBody.AppendInverseSignalWiring(inverseName, parameters, model);


    var source = $$"""
                   // <auto-generated />
                   using Godot;
                   using R3;
                   using System.CodeDom.Compiler;
                   using LokiCat.Godot.R3.RxProps;

                   namespace {{nameSpace}};

                   public partial class {{className}} {
                     private readonly IRxVar<{{parameters.AggregateType}}> {{fieldName}} = new RxVar<{{parameters.AggregateType}}>();
                     private bool {{connectedFlag}};

                     [GeneratedCode("SignalObservableGenerator", "1.0.0")]
                     public IRxProp<{{parameters.AggregateType}}> {{propertyName}} {
                       get {
                         if (!{{connectedFlag}}) {
                           {{connectedFlag}} = true;
                           {{fieldName}}.AsObservable()
                             .Skip(1)
                             .Subscribe(value => {
                               {{emissionBody.ToString().Trim()}}
                             })
                             .AddTo(this);
                         }
                         return {{fieldName}};
                       }
                     }
                   }
                   """;

    context.AddSource($"{className}.{propertyName}.g.cs", SourceText.From(source, Encoding.UTF8));
  }
}
